<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 8.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.css" integrity="sha256-gkQVf8UKZgQ0HyuxL/VnacadJ+D2Kox2TCEBuNQg5+w=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.zhaolq.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.25.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"androidstudio","dark":"androidstudio"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":"mac"},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.json","localsearch":{"enable":true,"top_n_per_article":1,"unescape":true,"preload":false}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="Nginx主页：https:&#x2F;&#x2F;nginx.org&#x2F; Nginx文档（包括模块参考）：http:&#x2F;&#x2F;nginx.org&#x2F;en&#x2F;docs&#x2F; 初学者指南：https:&#x2F;&#x2F;nginx.org&#x2F;en&#x2F;docs&#x2F;beginners_guide.html 管理员指南：https:&#x2F;&#x2F;docs.nginx.com&#x2F;nginx&#x2F;admin-guide&#x2F; Nginx软件包：https:&#x2F;&#x2F;nginx.org&#x2F;en&#x2F;">
<meta property="og:type" content="article">
<meta property="og:title" content="Nginx教程">
<meta property="og:url" content="https://blog.zhaolq.com/article/2019/11/Nginx%E6%95%99%E7%A8%8B/index.html">
<meta property="og:site_name" content="洋蔥">
<meta property="og:description" content="Nginx主页：https:&#x2F;&#x2F;nginx.org&#x2F; Nginx文档（包括模块参考）：http:&#x2F;&#x2F;nginx.org&#x2F;en&#x2F;docs&#x2F; 初学者指南：https:&#x2F;&#x2F;nginx.org&#x2F;en&#x2F;docs&#x2F;beginners_guide.html 管理员指南：https:&#x2F;&#x2F;docs.nginx.com&#x2F;nginx&#x2F;admin-guide&#x2F; Nginx软件包：https:&#x2F;&#x2F;nginx.org&#x2F;en&#x2F;">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.zhaolq.com/article/2019/11/Nginx%E6%95%99%E7%A8%8B/image-20191202173208171.png">
<meta property="og:image" content="https://blog.zhaolq.com/article/2019/11/Nginx%E6%95%99%E7%A8%8B/image-20191202140305257.png">
<meta property="og:image" content="https://blog.zhaolq.com/article/2019/11/Nginx%E6%95%99%E7%A8%8B/logo.png">
<meta property="article:published_time" content="2019-11-29T07:45:32.000Z">
<meta property="article:modified_time" content="2019-11-29T07:45:32.000Z">
<meta property="article:author" content="zhaolq">
<meta property="article:tag" content="Nginx">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.zhaolq.com/article/2019/11/Nginx%E6%95%99%E7%A8%8B/image-20191202173208171.png">


<link rel="canonical" href="https://blog.zhaolq.com/article/2019/11/Nginx%E6%95%99%E7%A8%8B/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.zhaolq.com/article/2019/11/Nginx%E6%95%99%E7%A8%8B/","path":"article/2019/11/Nginx教程/","title":"Nginx教程"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Nginx教程 | 洋蔥</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.umd.js" integrity="sha256-a+H7FYzJv6oU2hfsfDGM2Ohw/cR9v+hPfxHCLdmCrE8=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>




  <script src="/js/third-party/fancybox.js" defer></script>



  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">洋蔥</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">耳不闻人是非，目不视人之短，口不言人之过。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8A%9F%E8%83%BD%E7%AE%80%E4%BB%8B"><span class="nav-number">1.</span> <span class="nav-text">功能简介</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%89%B9%E5%88%AB"><span class="nav-number">2.</span> <span class="nav-text">特别</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BC%98%E7%82%B9"><span class="nav-number">3.</span> <span class="nav-text">优点</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%9E%B6%E6%9E%84"><span class="nav-number">4.</span> <span class="nav-text">架构</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%B3%E4%BA%8EWindows%E7%89%88%E6%9C%AC%E7%9A%84nginx"><span class="nav-number">5.</span> <span class="nav-text">关于Windows版本的nginx</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Linux%E4%B8%8B%E5%AE%89%E8%A3%85"><span class="nav-number">6.</span> <span class="nav-text">Linux下安装</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%8E%E6%BA%90%E5%AE%89%E8%A3%85"><span class="nav-number">6.1.</span> <span class="nav-text">从源安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E7%9B%AE%E5%BD%95%E6%88%96%E6%96%87%E4%BB%B6%E4%BD%8D%E7%BD%AE"><span class="nav-number">6.1.1.</span> <span class="nav-text">查看目录或文件位置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85"><span class="nav-number">6.2.</span> <span class="nav-text">编译安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD%E5%92%8C%E8%A7%A3%E5%8E%8B"><span class="nav-number">6.2.1.</span> <span class="nav-text">下载和解压</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E4%B8%8B%E8%BD%BD"><span class="nav-number">6.2.1.1.</span> <span class="nav-text">源码下载</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E4%B8%8B%E8%BD%BD"><span class="nav-number">6.2.1.2.</span> <span class="nav-text">命令下载</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E5%8E%8B"><span class="nav-number">6.2.1.3.</span> <span class="nav-text">解压</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96"><span class="nav-number">6.2.2.</span> <span class="nav-text">安装依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B0%E5%BB%BAnginx%E7%94%A8%E6%88%B7%E5%8F%8A%E7%94%A8%E6%88%B7%E7%BB%84"><span class="nav-number">6.2.3.</span> <span class="nav-text">新建nginx用户及用户组</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E9%85%8D%E7%BD%AE%E3%80%81%E7%BC%96%E8%AF%91%E3%80%81%E5%AE%89%E8%A3%85"><span class="nav-number">6.2.4.</span> <span class="nav-text">编译配置、编译、安装</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE"><span class="nav-number">6.2.4.1.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E5%92%8C%E5%AE%89%E8%A3%85"><span class="nav-number">6.2.4.2.</span> <span class="nav-text">编译和安装</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E7%A8%8B%E5%BA%8F%E7%89%88%E6%9C%AC"><span class="nav-number">6.2.5.</span> <span class="nav-text">查看程序版本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E5%B7%B2%E5%AE%89%E8%A3%85%E6%A8%A1%E5%9D%97"><span class="nav-number">6.2.6.</span> <span class="nav-text">查看已安装模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E9%BB%98%E8%AE%A4%E7%AB%AF%E5%8F%A3"><span class="nav-number">6.2.7.</span> <span class="nav-text">修改默认端口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81%E9%85%8D%E7%BD%AE%E6%98%AF%E5%90%A6%E5%90%88%E6%B3%95"><span class="nav-number">6.2.8.</span> <span class="nav-text">验证配置是否合法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E3%80%81%E9%87%8D%E5%90%AF%E3%80%81%E4%BB%8E%E5%AE%B9%E5%81%9C%E6%AD%A2%E3%80%81%E5%BC%BA%E5%88%B6%E5%81%9C%E6%AD%A2"><span class="nav-number">6.2.9.</span> <span class="nav-text">启动、重启、从容停止、强制停止</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%80%E6%9C%BA%E8%87%AA%E5%90%AF"><span class="nav-number">6.2.10.</span> <span class="nav-text">开机自启</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95"><span class="nav-number">6.2.11.</span> <span class="nav-text">测试</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="nav-number">7.</span> <span class="nav-text">快速入门</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E3%80%81%E5%81%9C%E6%AD%A2%E3%80%81%E9%87%8D%E6%96%B0%E5%8A%A0%E8%BD%BD%E9%85%8D%E7%BD%AE"><span class="nav-number">7.1.</span> <span class="nav-text">启动、停止、重新加载配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="nav-number">7.2.</span> <span class="nav-text">配置文件结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-number">7.3.</span> <span class="nav-text">静态资源服务器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%86%E5%A4%87"><span class="nav-number">7.3.1.</span> <span class="nav-text">准备</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE-1"><span class="nav-number">7.3.2.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95-1"><span class="nav-number">7.3.3.</span> <span class="nav-text">测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E7%9A%84%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-number">7.4.</span> <span class="nav-text">简单的代理服务器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E7%9B%AE%E6%A0%87%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-number">7.4.1.</span> <span class="nav-text">配置目标服务器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-number">7.4.2.</span> <span class="nav-text">配置代理服务器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95-2"><span class="nav-number">7.4.3.</span> <span class="nav-text">测试</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E5%92%8C%E8%BF%90%E8%A1%8C%E6%97%B6%E6%8E%A7%E5%88%B6"><span class="nav-number">8.</span> <span class="nav-text">进程和运行时控制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BB%E8%BF%9B%E7%A8%8B%E5%92%8C%E5%B7%A5%E4%BD%9C%E8%BF%9B%E7%A8%8B"><span class="nav-number">8.1.</span> <span class="nav-text">主进程和工作进程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%A7%E5%88%B6nginx"><span class="nav-number">8.2.</span> <span class="nav-text">控制nginx</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">9.</span> <span class="nav-text">配置文件</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEWeb%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-number">10.</span> <span class="nav-text">配置Web服务器</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE-server"><span class="nav-number">10.1.</span> <span class="nav-text">配置 server</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#listen-%E6%8C%87%E4%BB%A4"><span class="nav-number">10.1.1.</span> <span class="nav-text">listen 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#server-name-%E6%8C%87%E4%BB%A4"><span class="nav-number">10.1.2.</span> <span class="nav-text">server_name 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B"><span class="nav-number">10.1.3.</span> <span class="nav-text">示例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE-location"><span class="nav-number">10.2.</span> <span class="nav-text">配置 location</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%8F%98%E9%87%8F"><span class="nav-number">10.3.</span> <span class="nav-text">使用变量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%94%E5%9B%9E%E7%89%B9%E5%AE%9A%E7%8A%B6%E6%80%81%E7%A0%81"><span class="nav-number">10.4.</span> <span class="nav-text">返回特定状态码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%87%8D%E5%86%99URI%E8%AF%B7%E6%B1%82"><span class="nav-number">10.5.</span> <span class="nav-text">重写URI请求</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#last-%E5%92%8C-break"><span class="nav-number">10.5.1.</span> <span class="nav-text">last 和 break</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#redirect-%E5%92%8C-permanent"><span class="nav-number">10.5.2.</span> <span class="nav-text">redirect 和 permanent</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E7%A4%BA%E4%BE%8B"><span class="nav-number">10.5.3.</span> <span class="nav-text">简单示例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%87%8D%E5%86%99HTTP%E5%93%8D%E5%BA%94"><span class="nav-number">10.6.</span> <span class="nav-text">重写HTTP响应</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%84%E7%90%86%E9%94%99%E8%AF%AF"><span class="nav-number">10.7.</span> <span class="nav-text">处理错误</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E9%9D%99%E6%80%81%E5%86%85%E5%AE%B9%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-number">11.</span> <span class="nav-text">配置静态内容服务器</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B9%E7%9B%AE%E5%BD%95%E5%92%8C%E7%B4%A2%E5%BC%95%E6%96%87%E4%BB%B6"><span class="nav-number">11.1.</span> <span class="nav-text">根目录和索引文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%9D%E8%AF%95%E5%87%A0%E4%B8%AA%E9%80%89%E9%A1%B9"><span class="nav-number">11.2.</span> <span class="nav-text">尝试几个选项</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Nginx%E4%BC%98%E5%8C%96"><span class="nav-number">12.</span> <span class="nav-text">Nginx优化</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="nav-number">13.</span> <span class="nav-text">反向代理</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8E%8B%E7%BC%A9%E5%92%8C%E8%A7%A3%E5%8E%8B"><span class="nav-number">14.</span> <span class="nav-text">压缩和解压</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%86%85%E5%AE%B9%E7%BC%93%E5%AD%98"><span class="nav-number">15.</span> <span class="nav-text">内容缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%8B%E7%BB%8D"><span class="nav-number">15.1.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%AF%E7%94%A8%E5%93%8D%E5%BA%94%E7%BC%93%E5%AD%98"><span class="nav-number">15.2.</span> <span class="nav-text">启用响应缓存</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B6%E4%BB%96"><span class="nav-number">15.3.</span> <span class="nav-text">其他</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%97%A5%E5%BF%97"><span class="nav-number">16.</span> <span class="nav-text">配置日志</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%BB%E8%A6%81%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">17.</span> <span class="nav-text">主要应用场景</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97"><span class="nav-number">18.</span> <span class="nav-text">模块</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ngx-http-auth-basic-module"><span class="nav-number">18.1.</span> <span class="nav-text">ngx_http_auth_basic_module</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="zhaolq"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">zhaolq</p>
  <div class="site-description" itemprop="description">有用、有趣、有情义！</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">555</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">39</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">39</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/hellozhaolq" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hellozhaolq" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:hello.zhaolq@qq.com" title="E-Mail → mailto:hello.zhaolq@qq.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.zhaolq.com/article/2019/11/Nginx%E6%95%99%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhaolq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="洋蔥">
      <meta itemprop="description" content="有用、有趣、有情义！">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Nginx教程 | 洋蔥">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Nginx教程
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-11-29 15:45:32" itemprop="dateCreated datePublished" datetime="2019-11-29T15:45:32+08:00">2019-11-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/WebServer/" itemprop="url" rel="index"><span itemprop="name">WebServer</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>Nginx主页：<a target="_blank" rel="noopener" href="https://nginx.org/">https://nginx.org/</a></p>
<p>Nginx文档（包括模块参考）：<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/">http://nginx.org/en/docs/</a></p>
<p>初学者指南：<a target="_blank" rel="noopener" href="https://nginx.org/en/docs/beginners_guide.html">https://nginx.org/en/docs/beginners_guide.html</a></p>
<p>管理员指南：<a target="_blank" rel="noopener" href="https://docs.nginx.com/nginx/admin-guide/">https://docs.nginx.com/nginx/admin-guide/</a></p>
<p>Nginx软件包：<a target="_blank" rel="noopener" href="https://nginx.org/en/linux_packages.html">https://nginx.org/en/linux_packages.html</a></p>
<p>Nginx下载：<a target="_blank" rel="noopener" href="https://nginx.org/en/download.html">https://nginx.org/en/download.html</a></p>
<p>Nginx下载-历史归档：<a target="_blank" rel="noopener" href="https://nginx.org/download/">https://nginx.org/download/</a></p>
<span id="more"></span>

<h1 id="功能简介"><a href="#功能简介" class="headerlink" title="功能简介"></a>功能简介</h1><p><strong>Nginx</strong>（发音同engine x）是异步框架的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%B6%B2%E9%A0%81%E4%BC%BA%E6%9C%8D%E5%99%A8">网页服务器(HTTP服务器&#x2F;Web服务器)</a>，也是<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86">反向代理</a>服务器、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1">负载平衡器</a>、邮件代理服务器，以及Igor Sysoev最初编写的通用TCP&#x2F;UDP代理服务器。</p>
<p><a target="_blank" rel="noopener" href="https://www.yiibai.com/nginx">基本的HTTP服务器功能</a></p>
<p><a target="_blank" rel="noopener" href="https://www.yiibai.com/nginx">其他HTTP服务器功能</a></p>
<p><a target="_blank" rel="noopener" href="https://www.yiibai.com/nginx">邮件代理服务器功能</a></p>
<p><a href="TCP/UDP%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%8A%9F%E8%83%BD">TCP&#x2F;UDP代理服务器功能</a></p>
<p><a target="_blank" rel="noopener" href="https://www.yiibai.com/nginx">架构和可扩展性</a></p>
<h1 id="特别"><a href="#特别" class="headerlink" title="特别"></a>特别</h1><p>Nginx不同之处在于，其使用<strong>可扩展的事件驱动架构</strong>，而不是更传统的过程驱动架构。 这需要更低的内存占用，并且当并发连接扩大时，使内存使用更可预测。</p>
<p>Nginx的核心功能（具有高性能 HTTP和反向代理服务器，具有很好的控制访问和带宽能力，可以与各种应用程序高效集成），大大提高了Nginx的性能（可扩展性、可靠性），有助于使其成为任何网站或服务器的首选。</p>
<p>在传统的Web服务器体系结构中，每个客户端连接作为一个单独的进程或线程处理，随着网站的流行度增加，并发连接数量的增加，Web服务器减慢，延迟了对用户的响应。</p>
<p>从技术的角度来看，产生一个单独的进程&#x2F;线程需要将CPU切换到新的任务并创建一个新的运行时上下文，消耗额外的内存和CPU时间，从而对性能产生负面影响。</p>
<p><strong>Nginx开发的目标是实现<code>10</code>倍以上的性能，优化服务器资源的使用，同时也能够扩展和支持网站的动态增长。 因此，Nginx成为最知名的模块化，事件驱动，异步，单线程Web服务器和Web代理之一。</strong></p>
<h1 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h1><p>Nginx 是一个高性能的 Web 和反向代理服务器, 它具有有很多非常优越的特性:</p>
<p><strong>作为 Web 服务器</strong>：相比 Apache，Nginx 使用更少的资源，支持更多的并发连接，体现更高的效率，这点使 Nginx 尤其受到虚拟主机提供商的欢迎。能够支持高达 50,000 个并发连接数的响应，感谢 Nginx 为我们选择了 epoll and kqueue 作为开发模型.</p>
<p><strong>作为负载均衡服务器</strong>：Nginx 既可以在内部直接支持 Rails 和 PHP，也可以支持作为 HTTP代理服务器 对外进行服务。Nginx 用 C 编写, 不论是系统资源开销还是 CPU 使用效率都比 Perlbal 要好的多。</p>
<p><strong>作为邮件代理服务器</strong>: Nginx 同时也是一个非常优秀的邮件代理服务器(最早开发这个产品的目的之一也是作为邮件代理服务器)，Last.fm 描述了成功并且美妙的使用经验。</p>
<p>Nginx 安装非常简单，配置文件非常简洁(还能够支持perl语法)，启动特别容易，并且几乎可以做到7*24不间断运行，即使运行数个月也不需要重新启动，Bugs非常少。还能够在不间断服务的情况下进行软件版本的升级。</p>
<h1 id="架构"><a href="#架构" class="headerlink" title="架构"></a><a target="_blank" rel="noopener" href="https://www.yiibai.com/nginx/nginx-architecture.html">架构</a></h1><p>代码结构</p>
<p>工作模式</p>
<p>nginx进程角色</p>
<p>nginx缓存简介</p>
<h1 id="关于Windows版本的nginx"><a href="#关于Windows版本的nginx" class="headerlink" title="关于Windows版本的nginx"></a>关于Windows版本的nginx</h1><p>当nginx在Windows环境中工作时，nginx的Windows版本更像是一个概念证明，而不是一个功能完整的端口。 在这个时候，nginx和Windows内核架构有一些不能很好地交互的局限性。 用于Windows的nginx版本的已知问题包括并发连接数量低得多，性能下降，无缓存，无带宽监管。 nginx for Windows的未来版本将更加紧密地匹配主流功能。</p>
<p>Windows版下载地址： <a target="_blank" rel="noopener" href="https://nginx.org/en/download.html">https://nginx.org/en/download.html</a> </p>
<p><img src="/article/2019/11/Nginx%E6%95%99%E7%A8%8B/image-20191202173208171.png" alt="image-20191202173208171"></p>
<p>解压后运行 nginx.exe 文件启动。</p>
<p>也可以添加为服务，略…</p>
<h1 id="Linux下安装"><a href="#Linux下安装" class="headerlink" title="Linux下安装"></a>Linux下安装</h1><p><font color="red"><strong>基于 Centos 7 64bit 系统</strong></font></p>
<h2 id="从源安装"><a href="#从源安装" class="headerlink" title="从源安装"></a>从源安装</h2><p>CentOS、Ubuntu等安装最新稳定版和主线版方法： <a target="_blank" rel="noopener" href="https://nginx.org/en/linux_packages.html">https://nginx.org/en/linux_packages.html</a></p>
<h3 id="查看目录或文件位置"><a href="#查看目录或文件位置" class="headerlink" title="查看目录或文件位置"></a>查看目录或文件位置</h3><p> <a target="_blank" rel="noopener" href="https://www.runoob.com/linux/linux-system-contents.html">Linux 系统目录结构</a> </p>
<p> <a target="_blank" rel="noopener" href="https://man.linuxde.net/whereis">whereis命令</a> 、 <a target="_blank" rel="noopener" href="https://man.linuxde.net/locate_slocate">locate&#x2F;slocate命令</a> 、 <a target="_blank" rel="noopener" href="https://man.linuxde.net/find">find命令</a> 、 <a target="_blank" rel="noopener" href="https://man.linuxde.net/which">which命令</a> 、 <a target="_blank" rel="noopener" href="https://man.linuxde.net/rpm">rpm命令</a> </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">locate nginx</span><br><span class="line">find / | grep nginx</span><br><span class="line">rpm -ql nginx</span><br><span class="line">/etc/logrotate.d/nginx</span><br><span class="line">/etc/nginx/fastcgi.conf</span><br><span class="line">/etc/nginx/fastcgi.conf.default</span><br><span class="line">/etc/nginx/fastcgi_params</span><br><span class="line">/etc/nginx/fastcgi_params.default</span><br><span class="line">/etc/nginx/koi-utf</span><br><span class="line">/etc/nginx/koi-win</span><br><span class="line">/etc/nginx/mime.types</span><br><span class="line">/etc/nginx/mime.types.default</span><br><span class="line">/etc/nginx/nginx.conf</span><br><span class="line">/etc/nginx/nginx.conf.default</span><br><span class="line">/etc/nginx/scgi_params</span><br><span class="line">/etc/nginx/scgi_params.default</span><br><span class="line">/etc/nginx/uwsgi_params</span><br><span class="line">/etc/nginx/uwsgi_params.default</span><br><span class="line">/etc/nginx/win-utf</span><br><span class="line">/usr/bin/nginx-upgrade</span><br><span class="line">/usr/lib/systemd/system/nginx.service</span><br><span class="line">/usr/lib64/nginx/modules</span><br><span class="line">/usr/sbin/nginx</span><br><span class="line">/usr/share/doc/nginx-1.28.0</span><br><span class="line">/usr/share/doc/nginx-1.28.0/CHANGES</span><br><span class="line">/usr/share/doc/nginx-1.28.0/README</span><br><span class="line">/usr/share/doc/nginx-1.28.0/README.dynamic</span><br><span class="line">/usr/share/doc/nginx-1.28.0/UPGRADE-NOTES-1.6-to-1.10</span><br><span class="line">/usr/share/licenses/nginx-1.28.0</span><br><span class="line">/usr/share/licenses/nginx-1.28.0/LICENSE</span><br><span class="line">/usr/share/man/man3/nginx.3pm.gz</span><br><span class="line">/usr/share/man/man8/nginx-upgrade.8.gz</span><br><span class="line">/usr/share/man/man8/nginx.8.gz</span><br><span class="line">/usr/share/nginx/html/404.html</span><br><span class="line">/usr/share/nginx/html/50x.html</span><br><span class="line">/usr/share/nginx/html/en-US</span><br><span class="line">/usr/share/nginx/html/icons</span><br><span class="line">/usr/share/nginx/html/icons/poweredby.png</span><br><span class="line">/usr/share/nginx/html/img</span><br><span class="line">/usr/share/nginx/html/index.html</span><br><span class="line">/usr/share/nginx/html/nginx-logo.png</span><br><span class="line">/usr/share/nginx/html/poweredby.png</span><br><span class="line">/usr/share/vim/vimfiles/ftdetect/nginx.vim</span><br><span class="line">/usr/share/vim/vimfiles/ftplugin/nginx.vim</span><br><span class="line">/usr/share/vim/vimfiles/indent/nginx.vim</span><br><span class="line">/usr/share/vim/vimfiles/syntax/nginx.vim</span><br><span class="line">/var/lib/nginx</span><br><span class="line">/var/lib/nginx/tmp</span><br><span class="line">/var/log/nginx</span><br><span class="line">[root@localhost home]#</span><br></pre></td></tr></table></figure>

<h2 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h2><h3 id="下载和解压"><a href="#下载和解压" class="headerlink" title="下载和解压"></a>下载和解压</h3><h4 id="源码下载"><a href="#源码下载" class="headerlink" title="源码下载"></a>源码下载</h4><p> <a target="_blank" rel="noopener" href="https://nginx.org/en/download.html">https://nginx.org/en/download.html</a> ，下载并上传到服务器（这里选择最新稳定版本：<code>nginx-1.28.0</code>），如下图所示</p>
<p><img src="/article/2019/11/Nginx%E6%95%99%E7%A8%8B/image-20191202140305257.png" alt="image-20191202140305257"></p>
<h4 id="命令下载"><a href="#命令下载" class="headerlink" title="命令下载"></a>命令下载</h4><p> <a target="_blank" rel="noopener" href="https://man.linuxde.net/wget">wget命令</a> </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -c https://nginx.org/download/nginx-1.28.0.tar.gz</span><br></pre></td></tr></table></figure>

<h4 id="解压"><a href="#解压" class="headerlink" title="解压"></a>解压</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解压下载的文件</span></span><br><span class="line">tar -zxvf nginx-1.28.0.tar.gz</span><br></pre></td></tr></table></figure>

<h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><p>更新系统软件源，Centos <a target="_blank" rel="noopener" href="https://man.linuxde.net/yum">yum命令</a> </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">*************************** 前期依赖准备 ***************************</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">------- centos -------</span></span><br><span class="line">yum -y upgrade</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装 gcc 环境</span></span><br><span class="line">yum -y install gcc-c++</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装 pcre 依赖库（http://www.pcre.org/）</span></span><br><span class="line">yum -y install pcre pcre-devel</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装 zlib 依赖库（http://www.zlib.net）</span></span><br><span class="line">yum -y install zlib zlib-devel</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装 OpenSSL 安全套接字层密码库</span></span><br><span class="line">yum -y install openssl openssl-devel</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">------- centos -------</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#####################################################################################</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">------- Ubuntu -------</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">更新软件包列表</span></span><br><span class="line">apt-get update</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装依赖：gcc、g++依赖库</span></span><br><span class="line">apt-get install build-essential libtool</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装 pcre 依赖库（http://www.pcre.org/）</span></span><br><span class="line">apt-get install libpcre3 libpcre3-dev</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装 zlib 依赖库（http://www.zlib.net）</span></span><br><span class="line">apt-get install zlib1g-dev</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装 OpenSSL 安全套接字层密码库</span></span><br><span class="line">apt-get install openssl</span><br><span class="line">apt-get install libssl-dev</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">------- Ubuntu -------</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">*************************** 前期依赖准备 ***************************</span></span><br></pre></td></tr></table></figure>

<h3 id="新建nginx用户及用户组"><a href="#新建nginx用户及用户组" class="headerlink" title="新建nginx用户及用户组"></a>新建nginx用户及用户组</h3><p>使用 root 用户身份登录系统，执行以下命令创建新的用户。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">groupadd nginx</span><br><span class="line">useradd -g nginx -M nginx</span><br></pre></td></tr></table></figure>

<p><code>useradd</code>命令的<code>-M</code>参数用于不为<code>nginx</code>建立<code>home</code>目录<br>修改<code>/etc/passwd</code>，使得<code>nginx</code>用户无法bash登陆(nginx用户后面由<code>/bin/bash</code>改为<code>/sbin/nologin</code>)，</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/passwd</span><br></pre></td></tr></table></figure>

<p>然后找到有 nginx 那一行，把它修改为(后面由<code>/bin/bash</code>改为<code>/sbin/nologin</code>)：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改 nginx:x:1000:1000::/home/nginx:/bin/bash 为：</span></span><br><span class="line">nginx:x:1000:1000::/home/nginx:/sbin/nologin</span><br></pre></td></tr></table></figure>

<h3 id="编译配置、编译、安装"><a href="#编译配置、编译、安装" class="headerlink" title="编译配置、编译、安装"></a>编译配置、编译、安装</h3><h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost nginx-1.28.0]# <span class="built_in">cd</span> /data/local/nginx-1.28.0</span><br><span class="line">[root@localhost nginx-1.28.0]# ./configure --<span class="built_in">help</span> </span><br><span class="line"><span class="comment"># 生成Makefile文件</span></span><br><span class="line">[root@localhost nginx-1.28.0]# ./configure --prefix=/data/local/nginx \</span><br><span class="line">                               --with-http_ssl_module \</span><br><span class="line">                               --with-http_v2_module \</span><br><span class="line">                               --with-http_auth_request_module \</span><br><span class="line">                               --with-http_stub_status_module \</span><br><span class="line">                               --with-http_gzip_static_module \</span><br><span class="line">                               --with-http_realip_module \</span><br><span class="line">                               --with-http_sub_module \</span><br><span class="line">                               --with-http_addition_module \</span><br><span class="line">                               --with-http_flv_module \</span><br><span class="line">                               --with-http_mp4_module \</span><br><span class="line">                               --with-http_dav_module \</span><br><span class="line">                               --with-http_secure_link_module \</span><br><span class="line">                               --with-http_degradation_module \</span><br><span class="line">                               --with-stream \</span><br><span class="line">                               --with-stream_ssl_module \</span><br><span class="line">                               --with-pcre \</span><br><span class="line">                               --with-threads \</span><br><span class="line">                               --with-file-aio \</span><br><span class="line">                               --with-http_slice_module</span><br><span class="line">                               <span class="comment"># 以下可忽略</span></span><br><span class="line">                               --sbin-path=/data/local/nginx/sbin/nginx \</span><br><span class="line">                               --conf-path=/data/local/nginx/conf/nginx.conf \</span><br><span class="line">                               --error-log-path=/data/local/nginx/logs/error.log \</span><br><span class="line">                               --http-log-path=/data/local/nginx/logs/access.log \</span><br><span class="line">                               --pid-path=/data/local/nginx/run/nginx.pid \</span><br><span class="line">                               --user=nginx \</span><br><span class="line">                               --group=nginx </span><br><span class="line">Configuration summary</span><br><span class="line">  + using threads</span><br><span class="line">  + using system PCRE library</span><br><span class="line">  + using system OpenSSL library</span><br><span class="line">  + using system zlib library</span><br><span class="line"></span><br><span class="line">  nginx path prefix: <span class="string">&quot;/data/local/nginx&quot;</span></span><br><span class="line">  nginx binary file: <span class="string">&quot;/data/local/nginx/sbin/nginx&quot;</span></span><br><span class="line">  nginx modules path: <span class="string">&quot;/data/local/nginx/modules&quot;</span></span><br><span class="line">  nginx configuration prefix: <span class="string">&quot;/data/local/nginx/conf&quot;</span></span><br><span class="line">  nginx configuration file: <span class="string">&quot;/data/local/nginx/conf/nginx.conf&quot;</span></span><br><span class="line">  nginx pid file: <span class="string">&quot;/data/local/nginx/logs/nginx.pid&quot;</span></span><br><span class="line">  nginx error <span class="built_in">log</span> file: <span class="string">&quot;/data/local/nginx/logs/error.log&quot;</span></span><br><span class="line">  nginx http access <span class="built_in">log</span> file: <span class="string">&quot;/data/local/nginx/logs/access.log&quot;</span></span><br><span class="line">  nginx http client request body temporary files: <span class="string">&quot;client_body_temp&quot;</span></span><br><span class="line">  nginx http proxy temporary files: <span class="string">&quot;proxy_temp&quot;</span></span><br><span class="line">  nginx http fastcgi temporary files: <span class="string">&quot;fastcgi_temp&quot;</span></span><br><span class="line">  nginx http uwsgi temporary files: <span class="string">&quot;uwsgi_temp&quot;</span></span><br><span class="line">  nginx http scgi temporary files: <span class="string">&quot;scgi_temp&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="编译和安装"><a href="#编译和安装" class="headerlink" title="编译和安装"></a>编译和安装</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="comment"># 译并安装（会覆盖旧的二进制，但不会覆盖nginx配置</span></span></span><br><span class="line">[root@localhost nginx-1.28.0]# make &amp;&amp; make install</span><br><span class="line">[root@localhost nginx-1.28.0]# make clean</span><br><span class="line">[root@localhost nginx-1.28.0]# make distclean</span><br></pre></td></tr></table></figure>

<h3 id="查看程序版本"><a href="#查看程序版本" class="headerlink" title="查看程序版本"></a>查看程序版本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost nginx-1.28.0]# /data/local/nginx/sbin/nginx -v</span><br></pre></td></tr></table></figure>

<h3 id="查看已安装模块"><a href="#查看已安装模块" class="headerlink" title="查看已安装模块"></a>查看已安装模块</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost nginx-1.28.0]# /data/local/nginx/sbin/nginx -V</span><br></pre></td></tr></table></figure>

<h3 id="修改默认端口"><a href="#修改默认端口" class="headerlink" title="修改默认端口"></a>修改默认端口</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost nginx-1.28.0]# vim /data/local/nginx/conf/nginx.conf</span><br></pre></td></tr></table></figure>

<p>找到 <code>listen</code></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">... ...</span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span>  localhost;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#charset koi8-r;</span></span><br><span class="line">... ...</span><br></pre></td></tr></table></figure>

<h3 id="验证配置是否合法"><a href="#验证配置是否合法" class="headerlink" title="验证配置是否合法"></a>验证配置是否合法</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost nginx-1.28.0]# /data/local/nginx/sbin/nginx -t -c /data/local/nginx/conf/nginx.conf</span><br><span class="line">nginx: the configuration file /data/local/nginx/conf/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /data/local/nginx/conf/nginx.conf test is successful</span><br></pre></td></tr></table></figure>

<h3 id="启动、重启、从容停止、强制停止"><a href="#启动、重启、从容停止、强制停止" class="headerlink" title="启动、重启、从容停止、强制停止"></a>启动、重启、从容停止、强制停止</h3><p>当nginx启动后，可以使用 <code>-s</code> 参数运行 nginx 命令(调用NGINX可执行文件)发送信号来控制 nginx。未添加 nginx 为服务前只能通过以下方式控制 nginx。</p>
<p><a target="_blank" rel="noopener" href="https://man.linuxde.net/ps">ps 命令</a> 、<a target="_blank" rel="noopener" href="https://man.linuxde.net/grep">grep命令</a>、<a target="_blank" rel="noopener" href="https://man.linuxde.net/kill">kill 命令</a>、<a target="_blank" rel="noopener" href="https://man.linuxde.net/pkill">pkill命令</a> </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">nginx 管理的几种方式</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动</span></span><br><span class="line">[root@localhost nginx-1.28.0]# /data/local/nginx/sbin/nginx -c /etc/nginx/nginx.conf</span><br><span class="line">[root@localhost nginx-1.28.0]# ps -ef</span><br><span class="line">[root@localhost nginx-1.28.0]# ps -ef | grep nginx</span><br><span class="line">root      4092     1  0 14:51 ?        00:00:00 nginx: master process /data/local/nginx/sbin/nginx</span><br><span class="line">nginx     4093  4092  0 14:51 ?        00:00:00 nginx: worker process</span><br><span class="line">root      4180 29309  0 14:51 pts/0    00:00:00 grep --color=auto nginx</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启</span></span><br><span class="line">[root@localhost nginx-1.28.0]# /data/local/nginx/sbin/nginx -s reload # 重新加载配置，不会中断当前请求的处理</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">从容停止，此方式停止步骤是待nginx进程处理任务完毕进行停止。</span></span><br><span class="line">[root@localhost nginx-1.28.0]# /data/local/nginx/sbin/nginx -s quit</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">强制停止停止,此方式相当于先查出nginx进程<span class="built_in">id</span>再使用<span class="built_in">kill</span>命令强制杀掉进程。</span></span><br><span class="line">[root@localhost nginx-1.28.0]# /data/local/nginx/sbin/nginx -s stop</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">从容停止，4092是Nginx的主进程号(有两个进程，一个子进程一个父进程PPID)</span></span><br><span class="line">[root@localhost nginx-1.28.0]# kill -QUIT 4092</span><br><span class="line">[root@localhost nginx-1.28.0]# kill -3 4092</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">快速停止</span></span><br><span class="line">[root@localhost nginx-1.28.0]# kill -TERM 4092</span><br><span class="line">[root@localhost nginx-1.28.0]# kill -15 4092</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">强制停止</span></span><br><span class="line">[root@localhost nginx-1.28.0]# pkill -9 nginx</span><br></pre></td></tr></table></figure>

<h3 id="开机自启"><a href="#开机自启" class="headerlink" title="开机自启"></a>开机自启</h3><p><code>vim /etc/systemd/system/nginx.service</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nginx.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description= nginx server</span><br><span class="line">Documentation= https://zh.wikipedia.org/wiki/Systemd</span><br><span class="line">After=syslog.target network.target network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">User=root</span><br><span class="line">Group=root</span><br><span class="line">ExecStart=/data/local/nginx/sbin/nginx</span><br><span class="line">ExecReload=/data/local/nginx/sbin/nginx -s reload</span><br><span class="line">ExecStop=/data/local/nginx/sbin/nginx -s quit</span><br><span class="line">PIDFile=/data/local/nginx/logs/nginx.pid</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">systemctl = service + chkconfig</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start nginx.service</span><br><span class="line">systemctl enable nginx.service</span><br><span class="line">systemctl status nginx.service</span><br><span class="line">journalctl -u nginx.service</span><br></pre></td></tr></table></figure>

<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p> <code>curl localhost:80</code> </p>
<h1 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h1><h2 id="启动、停止、重新加载配置"><a href="#启动、停止、重新加载配置" class="headerlink" title="启动、停止、重新加载配置"></a>启动、停止、重新加载配置</h2><p>要启动 nginx，请运行可执行文件。 当nginx启动后，可以使用 <code>-s</code> 参数运行 nginx 命令(调用NGINX可执行文件)发送信号来控制 nginx。 使用以下语法：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">该命令应该在启动nginx的同一用户下执行</span></span><br><span class="line">nginx -s signal</span><br></pre></td></tr></table></figure>

<p>信号(<code>signal</code>)的值可以是以下之一：</p>
<ul>
<li><code>stop</code> - 立即关闭服务（快速关闭）</li>
<li><code>quit</code> - 正常关闭服务</li>
<li><code>reload</code> - 重新加载配置文件，不会中断当前请求的处理</li>
<li><code>reopen</code> - 重新打开日志文件</li>
</ul>
<p>等待工作进程完成请求后停止<code>nginx</code>进程，从容停止：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -s quit</span><br></pre></td></tr></table></figure>

<p>还可以使用Unix工具(如kill utility)，将信号直接发送给某个 ID 的进程。默认情况下，启动nginx后，主进程的进程ID写入 <code>/data/local/nginx/logs/</code>  或 <code>/run/</code> 目录下的 <code>nginx.pid</code>：</p>
<p> <a target="_blank" rel="noopener" href="https://man.linuxde.net/kill">kill 命令</a> </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep nginx</span><br><span class="line">root      4718 23794  0 17:38 pts/0    00:00:00 grep --color=auto nginx</span><br><span class="line">root     25877     1  0 17:10 ?        00:00:00 nginx: master process nginx</span><br><span class="line">nginx    25878 25877  0 17:10 ?        00:00:00 nginx: worker process</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">发送QUIT信号给进程25877，使其从容停止</span></span><br><span class="line">kill -s QUIT 25877</span><br><span class="line">kill -s 3 25877</span><br></pre></td></tr></table></figure>

<h2 id="配置文件结构"><a href="#配置文件结构" class="headerlink" title="配置文件结构"></a>配置文件结构</h2><p>在配置文件中可确定nginx及其模块的工作方式。默认情况下，配置文件名为 <code>nginx.conf</code> ，并放在目录： <code>/data/local/nginx/conf/</code> 或 <code>/etc/nginx/</code> 中。</p>
<p>配置文件由<strong>指令</strong>及其<strong>参数</strong>组成。</p>
<p><strong>简单指令</strong>：由空格分隔的名称和参数组成，并以分号(<code>;</code>)结尾。</p>
<p><strong>块指令</strong>：作为“容器”。具有与简单指令相同的结构，但不是以分号结尾，而是以大括号（ <code>{</code> 和 <code>}</code> ）包围的一组附加指令结束。</p>
<p><strong>上下文</strong>：如果块指令可以在大括号内部有其他指令，则称为<strong>上下文</strong>。例如：<code>events</code>上下文，<code>http</code>上下文，<code>server</code>上下文和<code>location</code>上下文。</p>
<p><strong>主上下文</strong>： <code>events</code> 、 <code>http</code> 、 <code>mail</code> 、 <code>stream</code> 指令驻留在<strong>主上下文</strong>中，<font color="red"><strong>有且只能有一个</strong></font>。</p>
<p><code>location</code> 在 <code>server</code> 块中，<code>server</code> 在 <code>http</code> 块中。</p>
<p> <code>#</code> 号之后视为注释。</p>
<p>**默认配置：**<a target="_blank" rel="noopener" href="https://github.com/nginx/nginx/blob/master/conf/nginx.conf">https://github.com/nginx/nginx/blob/master/conf/nginx.conf</a></p>
<h2 id="静态资源服务器"><a href="#静态资源服务器" class="headerlink" title="静态资源服务器"></a>静态资源服务器</h2><p>示例：服务器根据不同请求从不同本地目录提供响应文件。</p>
<h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><p>创建 <code>/home/data/html</code> 目录，放入 <code>index.html</code> ；</p>
<p>创建 <code>/home/data/images</code> 目录，放入图像 <code>logo.png</code> ；</p>
<p>创建 <code>/home/data/images/img</code> 目录，也放入图像 <code>logo.png</code> ；</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /home/data/html</span><br><span class="line">mkdir -p /home/data/images</span><br></pre></td></tr></table></figure>

<p>index.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html; charset=UTF-8&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>index<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>index.html<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>logo.png</p>
<p><img src="/article/2019/11/Nginx%E6%95%99%E7%A8%8B/logo.png" alt="img"></p>
<h3 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h3><p>打开配置文件(<code>/data/local/nginx/conf/nginx.conf</code>)，注释掉所有http块，启动一个新的http块：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="comment">## 静态网站</span></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="section">location</span> / &#123; <span class="comment"># 匹配请求 http://127.0.0.1/ ，默认访问index.html或index.htm</span></span><br><span class="line">            <span class="attribute">root</span> /home/data/html; <span class="comment"># 请求的根目录</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="section">location</span> /images/ &#123; <span class="comment"># 匹配请求 http://127.0.0.1/images/</span></span><br><span class="line">            <span class="attribute">root</span> /home/data/; <span class="comment"># 请求的根目录</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置文件 server 块可以配置<strong>服务器监听端口</strong>和<strong>服务器名称</strong>加以区分，标准端口 <code>80</code>。</p>
<p>当 nginx 决定使用哪个工作进程处理请求后，它会根据 <code>server</code> 块内部配置的 <code>location</code> 指令的参数匹配请求头中指定的URI的<strong>路径（请求地址PATH）</strong>。<font color="red">对于匹配请求，根据 <code>root</code> 指令的参数形成本地文件系统上所请求文件的路径。</font><font color="green">以上述配置为例，响应 <code>http://127.0.0.1/images/logo.png</code> 请求时，会匹配以 <code>/images/</code> 路径开头的 URI 请求，请求的根目录为 <code>/home/data/</code>，服务器将在本地文件系统 <code>/home/data/images</code> 目录下寻找请求资源 <code>logo.png</code> 并响应请求。如果资源不存在，nginx将发送一个指示 <code>404</code> 错误的响应。</font></p>
<p>如果有几个匹配的 <code>location</code> 块，nginx 会匹配最长参数的 <code>location</code> 块。<font color="red">上面 <code>location</code> 块参数最短长度为 <code>1</code>，因此只有当所有其他 <code>location</code> 块不能匹配时，才会使用该块。</font></p>
<h3 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h3><p>要<font color="red">应用新配置</font>，需将重载信号发送到nginx的主进程：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">验证配置</span></span><br><span class="line">/data/local/nginx/sbin/nginx -t</span><br><span class="line">nginx: the configuration file /data/local/nginx/conf/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /data/local/nginx/conf/nginx.conf test is successful</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重新加载配置，不会中断当前请求的处理</span></span><br><span class="line">/data/local/nginx/sbin/nginx -s reload</span><br></pre></td></tr></table></figure>

<p>如果配置错误或异常导致无法正常工作，可以尝试查看目录 <code>/data/local/nginx/logs/</code> 或 <code>/var/log/nginx/</code> 中的 <code>access.log</code> 和 <code>error.log</code> 文件。</p>
<p>访问：</p>
<p>​		 <code>http://127.0.0.1/</code> </p>
<p>​		 <code>http://127.0.0.1/images/logo.png</code> </p>
<p>​		 <code>http://127.0.0.1/images/img/logo.png</code> </p>
<h2 id="简单的代理服务器"><a href="#简单的代理服务器" class="headerlink" title="简单的代理服务器"></a>简单的代理服务器</h2><p> <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8">代理服务器</a> 、 <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86">反向代理</a> </p>
<p>nginx的一个常见用途是将其设置为反向代理服务器，代理服务器在接收客户端发送的请求后转发给 目标&#x2F;源 服务器，从 目标&#x2F;源 服务器返回的响应经过代理服务器后再传给客户端。</p>
<p>下面配置一个基本的代理服务器，它为来自本地目录的文件提供图像请求，并将所有其他请求发送到目标服务器。在此示例中，两个服务器将在单个 <code>nginx</code> 实例上定义。</p>
<h3 id="配置目标服务器"><a href="#配置目标服务器" class="headerlink" title="配置目标服务器"></a>配置目标服务器</h3><p>添加一个 <code>server</code> 块来定义目标服务器：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 目标服务器</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8080</span>;</span><br><span class="line">    <span class="attribute">root</span> /home/data/proxy; <span class="comment"># 当location块不包含root指令时使用</span></span><br><span class="line">    </span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是一个监听端口 <code>8080</code> 的简单服务器，并将所有请求<strong>映射</strong>到本地文件系统上的 <code>/home/data/proxy</code> 目录。</p>
<p><font color="red"><strong>注意</strong></font>：<code>root</code> 指令位于 <code>server</code> 块上下文中，当匹配用于服务请求的 <code>location</code> 块不包含自己的 <code>root</code> 指令时，将使用此 <code>root</code> 指令。</p>
<p>创建 <code>/home/data/proxy</code> 目录，放入 <code>proxy.html</code> ：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html; charset=UTF-8&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>proxy<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>proxy<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="配置代理服务器"><a href="#配置代理服务器" class="headerlink" title="配置代理服务器"></a>配置代理服务器</h3><p>添加一个 <code>server</code> 块来定义代理服务器：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 代理服务器</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8081</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="comment"># proxy_pass指令将请求传递给配置的URL。</span></span><br><span class="line">        <span class="attribute">proxy_pass</span> http://127.0.0.1:8080; </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="section">location</span> <span class="regexp">~ \.(gif|jpg|png)$</span> &#123;</span><br><span class="line">        <span class="attribute">root</span> /home/data/images; <span class="comment"># 请求的根目录</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第二个 <code>location</code> 块的参数是一个正则表达式，匹配所有以 <code>.gif</code> ，<code>.jpg</code> 或 <code>.png</code> 结尾的URI。</p>
<p>先匹配指定参数的 <code>location</code> 块，记住最长参数的一个；然后检查正则表达式，如果与正则表达式匹配，nginx会选择此 <code>location</code> ，否则选择之前记住的那一个。</p>
<h3 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h3><p>将重载信号发送到nginx的主进程：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">验证配置</span></span><br><span class="line">/data/local/nginx/sbin/nginx -t</span><br><span class="line">nginx: the configuration file /data/local/nginx/conf/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /data/local/nginx/conf/nginx.conf test is successful</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重新加载配置，不会中断当前请求的处理</span></span><br><span class="line">/data/local/nginx/sbin/nginx -s reload</span><br></pre></td></tr></table></figure>

<p>访问：</p>
<p>​		 <code>http://127.0.0.1:8080/proxy.html</code> </p>
<p>​		 <code>http://127.0.0.1:8081/proxy.html</code> </p>
<p>​		 <code>http://127.0.0.1:8081/logo.png</code> </p>
<p>​		 <code>http://127.0.0.1:8081/img/logo.png</code> </p>
<h1 id="进程和运行时控制"><a href="#进程和运行时控制" class="headerlink" title="进程和运行时控制"></a>进程和运行时控制</h1><h2 id="主进程和工作进程"><a href="#主进程和工作进程" class="headerlink" title="主进程和工作进程"></a>主进程和工作进程</h2><p>nginx有一个<strong>主进程</strong>和几个<strong>工作进程</strong>。如果启用缓存，<strong>缓存加载程序</strong>和<strong>缓存管理器进程</strong>也将在启动时运行。</p>
<p><strong>主进程</strong> 主要作用是读取和评估配置文件以及维护工作进程。</p>
<p><strong>工作进程</strong> 对请求进行实际处理。 nginx采用基于事件的模型和依赖于操作系统的机制来有效地在工作进程之间分配请求。 工作进程的数量可在 <code>nginx.conf</code> 配置文件中修改，<code>worker_processes auto;</code> 表示自动调整为可用CPU内核数(请参阅<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/ngx_core_module.html?&_ga=1.19081464.1509956953.1490042234#worker_processes">worker_processes</a>)。</p>
<h2 id="控制nginx"><a href="#控制nginx" class="headerlink" title="控制nginx"></a>控制nginx</h2><p>相信你已经阅读了 <a href>启动、停止、重新加载配置</a> 。</p>
<p>主进程 ID 可以使用 <code>pid</code> 指令在 <code>nginx.conf</code> 文件中进行更改。主进程支持以下信号：</p>
<ul>
<li><code>TERM</code>, <code>INT</code> - 快速关闭</li>
<li><code>QUIT</code> - 正常关闭</li>
<li><code>HUP</code> - 改变配置，跟上改变的时区(仅适用于FreeBSD和Linux)，<strong>使用新配置启动新的工作进程，正常关闭旧的工作进程</strong></li>
<li><code>USR1</code> - 重新打开日志文件</li>
<li><code>USR2</code> - 升级可执行文件</li>
<li><code>WINCH</code> - 正常关闭工作进程</li>
</ul>
<p>个别工作进程可以用信号来控制，尽管这不是必需的。 支持的信号有：</p>
<ul>
<li>TERM, INT - 快速关闭</li>
<li>QUIT - 正常关闭</li>
<li>USR1 - 重新打开日志文件</li>
<li>WINCH - 调试异常终止(需要启用<code>debug_points</code>)</li>
</ul>
<p><font color="red">为了使 nginx 重新读取配置文件，应将 HUP 信号发送到主进程。 </font>主进程首先检查语法有效性，然后尝试应用新配置，即打开日志文件和新的监听套接字。  如果失败，它会回滚更改，并继续使用旧配置。 如果成功，它将启动新的工作进程，并向旧的工作进程发送消息，请求它们正常关闭。旧工作进程密切监听套接字，并继续为旧客户端服务。 在所有客户端被服务之后，旧的工作进程被关闭。</p>
<h1 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h1><p>相信你已经阅读了 <a href>配置文件结构</a> 。</p>
<p>为了使配置更易于维护，建议您将其拆分为存储在 <code>/data/local/nginx/conf/conf.d/</code> 或 <code>/etc/nginx/conf.d/</code> 目录中的一组功能特定文件，并在主 <code>nginx.conf</code> 文件中使用 <code>include</code> 指令引用（包函）指定文件的内容。如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">include conf.d/http;</span><br><span class="line">include conf.d/stream;</span><br><span class="line">include conf.d/exchange-enhanced;</span><br></pre></td></tr></table></figure>

<p> <code>http</code> 为 <code>/data/local/nginx/conf/conf.d/</code> 或 <code>/etc/nginx/conf.d/</code> 目录下的文件名，其内容是从 <code>nginx.conf</code> 中拆分出来的 <code>http</code> 块，例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    server &#123;</span><br><span class="line">        location / &#123;</span><br><span class="line">            root /home/data/html;</span><br><span class="line">        &#125;</span><br><span class="line">        location /images/ &#123;</span><br><span class="line">            root /home/data/;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>几个用于<strong>不同流量类型</strong>的指令（<font color="red"><strong>有且只能有一个</strong></font>）：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/ngx_core_module.html?&_ga=1.10035445.1509956953.1490042234#events">events</a> – 一般连接处理</li>
<li><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_core_module.html?&_ga=1.10035445.1509956953.1490042234#http">http</a> – HTTP协议流量</li>
<li><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/mail/ngx_mail_core_module.html?&_ga=1.85614937.1509956953.1490042234#mail">mail</a> – Mail协议流量</li>
<li><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/stream/ngx_stream_core_module.html?&_ga=1.85614937.1509956953.1490042234#stream">stream</a> – TCP协议流量</li>
</ul>
<p>这些指令都可以包含多个 **server上下文（server块）**来定义控制请求处理的虚拟服务器。<strong>不同流量类型的 server 块内的指令有所不同。</strong></p>
<p><strong>对于HTTP流量</strong>（<code>http</code>上下文），每个 server 指令控制处理来自特定端口的资源请求，server 上下文中的多个 location 指令定义了如何处理特定的 URI 集合。</p>
<p><strong>对于 mail 和 stream 流量</strong>（<code>mail</code> 和 <code>stream</code> 上下文），每个 server 指令控制处理来自特定TCP端口或UNIX套接字的资源请求。</p>
<p><font color="red">对于大多数指令，<strong>子上下文</strong> 可以 <strong>继承</strong> 和 <strong>覆盖</strong> <strong>父上下文</strong> 指令的值。</font>有关上下文遗留的更多信息，请参阅<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html?&_ga=1.110839877.1509956953.1490042234#proxy_set_header">proxy_set_header</a>指令的文档。</p>
<h1 id="配置Web服务器"><a href="#配置Web服务器" class="headerlink" title="配置Web服务器"></a>配置Web服务器</h1><h2 id="配置-server"><a href="#配置-server" class="headerlink" title="配置 server"></a>配置 server</h2><p>虚拟服务器由 <code>http</code> 上下文中的 <code>server</code> 指令定义，且至少包含一个 <code>server</code> 指令来定义虚拟服务器。</p>
<h3 id="listen-指令"><a href="#listen-指令" class="headerlink" title="listen 指令"></a><code>listen</code> 指令</h3><p>服务器侦听请求的 IP 和 port（或Unix域套接字和路径）。</p>
<p>如果省略端口，则使用标准端口。</p>
<p>如果<font color="red">省略 IP 地址</font>，服务器将<font color="red">侦听所有 IP 地址</font>。</p>
<p>如果不包含 <code>listen</code> 指令，则“标准”端口为 <code>80/tcp</code> ，“default”端口为 <code>8000/tcp</code> ，具体取决于超级用户权限。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下面的示例监听127.0.0.1:8080。还可以监听其他本机ip，例如：内网和公网ip。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">监听vps的公网ip会失败：Cannot assign requested address。因为这并不是本机ip，而是vps厂商的内部路由</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用内网ip(192.168.3.77)访问：Failed connect to 192.168.3.77:8080; Connection refused</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen 127.0.0.1:8080;</span><br><span class="line">    # The rest of server configuration</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="server-name-指令"><a href="#server-name-指令" class="headerlink" title="server_name 指令"></a><code>server_name</code> 指令</h3><p>服务器侦听请求的域名，<font color="red">多个域名空格分隔</font>。参数可以是 <strong>完整名称、通配符(*)、正则表达式</strong>。</p>
<p>如果有多个 <code>server</code> 块与请求的 IP 和 port 相匹配，则将根据 <code>server</code> 块中的 <code>server_name</code> 指令值匹配请求的域名。</p>
<p>​		<strong>请求域名匹配优先级：</strong><br>​				1、确切的名字(完整准确的名称)<br>​				2、以星号开头的最长通配符，例如:<code>*.example.org</code><br>​				3、以星号结尾的最长通配符，如：<code>mail.*</code><br>​				4、第一个匹配正则表达式（按照出现在配置文件中的顺序）</p>
<p>如果有多个 <code>server</code> 块与请求的 IP 和 port 相匹配，每个 <code>server</code> 块的 <code>server_name</code> 与请求的域名都不匹配，就会将请求路由到匹配 IP 和 port 的 <strong>默认服务器</strong>（<code>default_server</code> ）。若未明确指定默认服务器，则将第一个 <code>server</code> 块作为默认服务器（按照出现在配置文件中的顺序）。</p>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><p>创建 <code>/home/data/html/vhost1</code> 目录，放入 <code>index.html</code> ；</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html; charset=UTF-8&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>vhost1<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>vhost1<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>创建 <code>/home/data/html/vhost2</code> 目录，放入 <code>index.html</code> ；</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html; charset=UTF-8&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>vhost2<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>vhost2<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>创建 <code>/home/data/log</code> 目录，放入 <code>vhost1.com.log</code> 和 <code>vhost2.com.log</code> ；</p>
<p>编辑 <code>/etc/hosts</code> 新增内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1 vhost1.com www.vhost1.com</span><br><span class="line">127.0.0.1 vhost2.com www.vhost2.com</span><br></pre></td></tr></table></figure>



<p>配置示例，两个虚拟服务器，分别对应两个域名，第二个服务器设置为默认服务器：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">9001</span>;</span><br><span class="line">    <span class="attribute">server_name</span> vhost1.com www.vhost1.com;</span><br><span class="line">    <span class="attribute">index</span> index.html index.html;</span><br><span class="line">    <span class="attribute">root</span> /home/data/html/vhost1;</span><br><span class="line">    <span class="attribute">access_log</span>  /home/data/log/vhost1.com.log;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">9001</span> default_server;</span><br><span class="line">    <span class="attribute">server_name</span> vhost2.com www.vhost2.com;</span><br><span class="line">    <span class="attribute">index</span> index.html index.html;</span><br><span class="line">    <span class="attribute">root</span> /home/data/html/vhost2;</span><br><span class="line">    <span class="attribute">access_log</span>  /home/data/log/vhost2.com.log;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试访问：</p>
<p>​		 <code>http://vhost1.com:9001</code> ，访问匹配的 <code>server_name</code> ，返回 vhost1 的主页。</p>
<p>​		 <code>http://www.vhost1.com:9001</code> ，访问匹配的 <code>server_name</code> ，返回 vhost1 的主页。</p>
<p>​		 <code>http://www.vhost2.com:9001</code> ，访问匹配的 <code>server_name</code> ，返回 vhost2 的主页。</p>
<p>​		 <code>http://vhost2.com:9001</code> ，访问匹配的 <code>server_name</code> ，返回 vhost2 的主页。</p>
<p>​		 <code>http://127.0.0.1:9001</code> ，无匹配的 <code>server_name</code> ，访问默认服务器，返回 vhost2 的主页。</p>
<p>​		 <code>http://106.12.173.48:9001</code> ，无匹配的 <code>server_name</code> ，访问默认服务器，返回 vhost2 的主页。</p>
<p>​		 <code>http://localhost:9001</code> ，无匹配的 <code>server_name</code> ，访问默认服务器，返回 vhost2 的主页。</p>
<h2 id="配置-location"><a href="#配置-location" class="headerlink" title="配置 location"></a>配置 location</h2><p>相信你已经阅读了 <a href>静态资源服务器</a> 和 <a href>简单的代理服务器</a> 。</p>
<p><code>location</code> 指令有两种类型的参数：前缀字符串（路径名）和正则表达式。 对于要匹配路径名的请求URI，<font color="red"><strong>必须以路径名开头</strong></font>。</p>
<p>选择处理请求的 <code>location</code> 的确切逻辑：<a target="_blank" rel="noopener" href="https://www.yiibai.com/nginx/nginx-web-server.html">https://www.yiibai.com/nginx/nginx-web-server.html</a> </p>
<h2 id="使用变量"><a href="#使用变量" class="headerlink" title="使用变量"></a>使用变量</h2><p>可以使用配置文件中的变量，使NGINX进程的请求根据定义的情况而有所不同。 变量是在运行时计算的命名值，用作指令的参数。 一个变量由它的名字开头的 <code>$</code> (美元)符号表示。 变量根据NGINX的状态定义信息，例如正在处理的请求的属性。</p>
<p><font color="red">有许多预定义的变量，</font>如核心HTTP变量，您可以使用 <code>set</code> ，<code>map</code> 和 <code>geo</code> 指令定义自定义变量。 大多数变量在运行时计算的，并包含与特定请求相关的信息。 例如，<code>$remote_addr</code> 包含客户端IP地址，<code>$uri</code> 保存当前的URI值。</p>
<h2 id="返回特定状态码"><a href="#返回特定状态码" class="headerlink" title="返回特定状态码"></a>返回特定状态码</h2><p>一些网站 URI 需要立即返回具有特定错误或重定向代码的响应，例如当页面被暂时移动或永久移动时，最简单的方法是使用 <code>return</code> 指令。</p>
<p><code>return</code> 指令可以包含在 <code>location</code> 和 <code>server</code> 上下文中。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">return code [text];</span><br><span class="line">return code URL;</span><br><span class="line">return URL;</span><br></pre></td></tr></table></figure>



<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /blog &#123;</span><br><span class="line">    <span class="comment"># 返回永久移动，并重定向</span></span><br><span class="line">    <span class="attribute">return</span> <span class="number">301</span> https://blog.jonsnows.com/about/;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">location</span> /blog &#123;</span><br><span class="line">	<span class="comment"># 返回未找到的404状态码</span></span><br><span class="line">	<span class="attribute">return</span> <span class="number">404</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">location</span> /blog &#123;</span><br><span class="line">    <span class="comment"># 返回服务器内部错误</span></span><br><span class="line">    <span class="attribute">return</span> <span class="number">500</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="重写URI请求"><a href="#重写URI请求" class="headerlink" title="重写URI请求"></a>重写URI请求</h2><p>实现 URI 重写的指令 <code>rewrite</code> ，格式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rewrite regex replacement [flag];</span><br></pre></td></tr></table></figure>

<p>regex：<font color="green"><strong>必须</strong></font>，匹配 URI 的正则表达式。</p>
<p>replacement：<font color="green"><strong>必须</strong></font>，将 regex 正则匹配到的内容替换成 replacement。如果 regex 里有正则，则可以使用 <code>$index</code> 来捕获分组。<font color="green"><strong>正则捕获组</strong></font>相关链接：<br>				 <a target="_blank" rel="noopener" href="https://blog.csdn.net/lxcnn/article/details/4146148">https://blog.csdn.net/lxcnn/article/details/4146148</a><br>				 <a target="_blank" rel="noopener" href="https://dailc.github.io/2017/08/01/regularExpressionConcepts.html">https://dailc.github.io/2017/08/01/regularExpressionConcepts.html</a> </p>
<p>flag：<font color="green"><strong>非必须</strong></font>，标志。有如下值：<br>		<strong>last:</strong> 本条规则匹配完成后，继续搜索与重写的 URI 匹配的 <code>location</code> 。浏览器地址栏不变<br>		<strong>break:</strong> 本条规则匹配完成即终止，取消搜索与重写的 URI 匹配的 <code>location</code> 。浏览器地址栏不变<br>		<strong>redirect:</strong> 返回 302 临时重定向，爬虫不更新 <code>URI</code> 。浏览器地址栏改变<br>		<strong>permanent:</strong> 返回 301 永久重定向，爬虫更新 <code>URI</code> 。浏览器地址栏改变<br><font color="green">当 replacement 以 <code>http://</code> 或 <code>https://</code> 开头，<strong>无论 flag 为何值（有值或无值）</strong>，都会停止处理后续内容，并直接302重定向（redirect）返回给客户端。</font></p>
<p>可以在 <code>location</code> 和 <code>server</code> 上下文中包含多个 <code>rewrite</code> 指令，nginx 按照它们发生的顺序逐个执行，匹配到一个 <code>rewrite</code> 指令就不再继续匹配。</p>
<h3 id="last-和-break"><a href="#last-和-break" class="headerlink" title="last 和 break"></a><code>last</code> 和 <code>break</code></h3><p><strong><code>location</code> 块外：</strong></p>
<ul>
<li>当出现在 <code>location</code> 块外时，两者的作用是一致的没有任何差异，都会跳过当前上下文的后续指令，搜索与重写的 URI 匹配的 <code>location</code> 。</li>
<li><font color="green">当 flag 省略且 replacement 不以 <code>http://</code> 或 <code>https://</code> 开头，则 flag 默认值可以看做 last 或 break，因为无差异。</font></li>
</ul>
<p><strong><code>location</code> 块内：</strong></p>
<ul>
<li><code>last</code> - 跳过当前上下文的后续指令；再次进入 <code>server</code> 块，继续搜索与重写的 URI 匹配的 <code>location</code> ，并执行新 <code>location</code> 中的 <code>rewrite</code> 指令（URI可以再次更改，往下继续匹配）。跳出 <code>location</code> 作用域。</li>
<li><code>break</code> - 跳过当前上下文的后续指令；取消搜索与重写的 URI 匹配的 <code>location</code> 。不会跳出 <code>location</code> 作用域。</li>
<li><font color="green">当 flag 省略且 replacement 不以 <code>http://</code> 或 <code>https://</code> 开头，则 flag 默认值为 last。</font></li>
</ul>
<h3 id="redirect-和-permanent"><a href="#redirect-和-permanent" class="headerlink" title="redirect 和 permanent"></a><code>redirect</code> 和 <code>permanent</code></h3><p>从实现功能的角度上去看，redirect 和 permanent 是一样的，不存在好坏，也不存在性能问题。但类似SEO(或百度爬你的网站时)，会对你到底是永久性重定向还是临时重定向感兴趣。</p>
<h3 id="简单示例"><a href="#简单示例" class="headerlink" title="简单示例"></a>简单示例</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 请求1： http://106.12.173.48:8082/download/resources/img/logo.png</span></span><br><span class="line"><span class="comment"># 请求2： http://106.12.173.48:8082/download/resources/pic/logo.png</span></span><br><span class="line"><span class="comment"># 请求3： http://106.12.173.48:8082/download/logo.png</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8082</span>;</span><br><span class="line">    <span class="attribute">rewrite</span><span class="regexp"> ^/download/(.*)/img/(.*)\.(.*)$</span> /<span class="variable">$1</span>/img/<span class="variable">$2</span>.<span class="variable">$3</span> <span class="literal">permanent</span>; <span class="comment"># 请求重写 http://106.12.173.48:8082/resources/img/logo.png</span></span><br><span class="line">    <span class="attribute">rewrite</span><span class="regexp"> ^/download/(.*)/pic/(.*)\.(.*)$</span> /<span class="variable">$1</span>/pic/<span class="variable">$2</span>.<span class="variable">$3</span> <span class="literal">permanent</span>; <span class="comment"># 请求重写 http://106.12.173.48:8082/resources/pic/logo.png</span></span><br><span class="line">    <span class="attribute">rewrite</span><span class="regexp"> ^/download/(.*)</span> /resources/<span class="variable">$1</span> <span class="literal">permanent</span>; <span class="comment"># 请求重写 http://106.12.173.48:8082/resources/logo.png</span></span><br><span class="line">    <span class="comment"># return 403; # last和break标志会跳过后续指令，但在location中rewrite后可能会执行return。</span></span><br><span class="line">    </span><br><span class="line">    <span class="section">location</span> /images/ &#123;</span><br><span class="line">        <span class="attribute">root</span> /home/data/;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> /resources/ &#123;</span><br><span class="line">        <span class="comment"># rewrite ^/resources/img/(.*)$ $scheme://$server_addr:$server_port/images/$1;</span></span><br><span class="line">        <span class="attribute">rewrite</span><span class="regexp"> ^/resources/img/(.*)$</span> /images/<span class="variable">$1</span> <span class="literal">permanent</span>; <span class="comment"># 请求重定向到 http://106.12.173.48:8082/images/logo.png</span></span><br><span class="line">        <span class="attribute">rewrite</span><span class="regexp"> ^/resources/pic/(.*)$</span> /images/<span class="variable">$1</span> <span class="literal">permanent</span>; <span class="comment"># 请求重定向到 http://106.12.173.48:8082/images/logo.png</span></span><br><span class="line">        <span class="attribute">rewrite</span><span class="regexp"> ^/resources/(.*)</span> https://www.baidu.com/<span class="variable">$1</span> <span class="literal">permanent</span>; <span class="comment"># $1:捕获匹配正则的第二组参数。请求重定向到 https://www.baidu.com/logo.png</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="重写HTTP响应"><a href="#重写HTTP响应" class="headerlink" title="重写HTTP响应"></a>重写HTTP响应</h2><p>ngx_http_sub_module模块是一个过滤器，通过将一个指定的字符串替换为另一个字符串来修改响应。该模块已经内置在nginx中，但默认未安装，安装需要加上配置参数：<code>--with-http_sub_module</code>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost nginx-1.28.0]# ./configure --prefix=/data/local/nginx \</span><br><span class="line">--pid-path=/data/local/nginx/run/nginx.pid \</span><br><span class="line">--with-http_ssl_module \</span><br><span class="line">--user=nginx \</span><br><span class="line">--group=nginx \</span><br><span class="line">--with-http_ssl_module \</span><br><span class="line">--with-http_v2_module \</span><br><span class="line">--with-http_auth_request_module \</span><br><span class="line">--with-http_stub_status_module \</span><br><span class="line">--with-http_gzip_static_module \</span><br><span class="line">--with-http_realip_module \</span><br><span class="line">--with-http_sub_module \</span><br><span class="line">--with-http_addition_module \</span><br><span class="line">--with-http_flv_module \</span><br><span class="line">--with-http_mp4_module \</span><br><span class="line">--with-http_dav_module \</span><br><span class="line">--with-http_secure_link_module \</span><br><span class="line">--with-http_degradation_module \</span><br><span class="line">--with-stream \</span><br><span class="line">--with-stream_ssl_module \</span><br><span class="line">--with-pcre \</span><br><span class="line">--with-threads \</span><br><span class="line">--with-file-aio \</span><br><span class="line">--with-http_slice_module</span><br></pre></td></tr></table></figure>

<p>当需要重写或更改HTTP响应中的内容时，例如将一个字符串替换为另一个字符串，可以使用 <code>sub_filter</code> 指令。该指令支持变量和替代链，使更复杂的更改成为可能。</p>
<p><code>sub_filter_once</code> 指令告诉 nginx 在一个 <code>location</code> 内是否连续使用 <code>sub_filter</code> 伪指令（替换一次或全部替换）。</p>
<p>示例一：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">    <span class="attribute">sub_filter</span>      /blog/ /blog-staging/;</span><br><span class="line">    <span class="attribute">sub_filter_once</span> <span class="literal">off</span>; <span class="comment"># 全部替换</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>示例二：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">    <span class="attribute">sub_filter</span>     <span class="string">&#x27;href=&quot;http://127.0.0.1:8080/&#x27;</span>    <span class="string">&#x27;href=&quot;http://<span class="variable">$host</span>/&#x27;</span>;</span><br><span class="line">    <span class="attribute">sub_filter</span>     <span class="string">&#x27;img src=&quot;http://127.0.0.1:8080/&#x27;</span> <span class="string">&#x27;img src=&quot;http://<span class="variable">$host</span>/&#x27;</span>;</span><br><span class="line">    <span class="attribute">sub_filter_once</span> <span class="literal">on</span>; <span class="comment"># 替换一次</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="处理错误"><a href="#处理错误" class="headerlink" title="处理错误"></a>处理错误</h2><p>使用 <code>error_page</code> 指令可以 <strong>返回自定义错误页面</strong>、<strong>替换响应中的错误代码</strong>、<strong>重定向到其他 URI</strong> 。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">    <span class="comment"># root /home/data/html;</span></span><br><span class="line">    <span class="attribute">root</span> html;</span><br><span class="line">    <span class="attribute">error_page</span> <span class="number">404</span> /50x.html; <span class="comment"># 返回自定义错误页面</span></span><br><span class="line">    <span class="attribute">error_page</span> <span class="number">404</span> =<span class="number">200</span> /50x.html; <span class="comment"># 替换响应中的错误代码，产生404时返回200，内容为50x.html。</span></span><br><span class="line">    <span class="attribute">error_page</span> <span class="number">404</span> =<span class="number">301</span> https://www.baidu.com; <span class="comment"># 重定向的方式处理错误页面</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 应用访问量过大时可能导致nginx返回50x错误，将静态页面返回给用户也是一种在极端情况下比较合适的降级方案。</span></span><br><span class="line">    <span class="attribute">error_page</span> <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span> <span class="variable">@jump_to_error</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">location</span> <span class="variable">@jump_to_error</span> &#123;</span><br><span class="line">    <span class="attribute">lua_code_cache</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">content_by_lua_file</span> /<span class="literal">error</span>.html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>error_page 在一次请求中只能响应一次。<br>对应的 nginx 有另外一个配置可以控制这个选项 <code>recursive_error_pages</code> ，默认为 off ，作用是：启用或禁用使用 error_page 指令进行多次重定向。此类重定向的数量是有限的。</p>
<h1 id="配置静态内容服务器"><a href="#配置静态内容服务器" class="headerlink" title="配置静态内容服务器"></a>配置静态内容服务器</h1><h2 id="根目录和索引文件"><a href="#根目录和索引文件" class="headerlink" title="根目录和索引文件"></a>根目录和索引文件</h2><p><code>root</code> 指令指定用于搜索文件的根目录，nginx 将请求 URI 附加到 <code>root</code> 指令指定的路径。该指令可以放置在 <code>http</code> ，<code>server</code> 或 <code>location</code> 上下文中。 <code>server</code> 上下文中的 <code>root</code> 指令适用于不包括 <code>root</code> 指令的所有 <code>location</code> 块。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">root</span> /home/data/;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> /images/ &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> <span class="regexp">~ \.(mp3|mp4)</span> &#123;</span><br><span class="line">        <span class="attribute">root</span> /home/data/media;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果请求<strong>以 <code>/images/</code> 开头</strong>，nginx 会在文件系统的 <code>/home/data/images/</code> 目录中搜索文件；但如果 URI 以 <code>.mp3</code> 或 <code>.mp4</code> 扩展名结尾，则 nginx 会在 <code>/home/data/media</code> 目录中搜索 <code>.mp3</code> 或 <code>.mp4</code> 文件。</p>
<p>如果请求<strong>以斜杠结尾</strong>，则 nginx 将其视为对目录的请求，并尝试在目录中找到<strong>索引文件</strong>。</p>
<p><code>index</code> 指令定义<strong>索引文件的名称</strong>（默认值为 <code>index.html</code> ）。可以在 <code>index</code> 指令中列出多个索引文件名，nginx 以指定的顺序检查索引文件是否存在；检查方式是将索引文件的名称附加到 URI 后面，然后对 URI 内部重定向（发起新的 <code>location</code> 搜索），请求可能会在另一个 <code>location</code> 中结束。nginx 以指定的顺序检查索引文件是否存在，并返回第一个找到的文件。示例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">    <span class="attribute">root</span> /home/data;</span><br><span class="line">    <span class="attribute">index</span> index.html index.php;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">location</span> <span class="regexp">~ \.php</span> &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> localhost:<span class="number">8000</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解释：如果请求中的 URI 是 <code>/path/</code> ，并且 <code>/home/data/path/index.html</code> 不存在，但是 <code>/home/data/path/index.php</code> 存在，则会将 <code>/path/index.php</code> 内部重定向映射到第二个 <code>location</code> 。 最后，请求被代理。</p>
<h2 id="尝试几个选项"><a href="#尝试几个选项" class="headerlink" title="尝试几个选项"></a>尝试几个选项</h2><table>
<thead>
<tr>
<th>Syntax:</th>
<th><code>try_files file ... uri;</code><br><code>try_files file ... =code;</code></th>
</tr>
</thead>
<tbody><tr>
<td>Default:</td>
<td>—</td>
</tr>
<tr>
<td>Context:</td>
<td><code>server</code>, <code>location</code></td>
</tr>
</tbody></table>
<p>按指定顺序检查文件是否存在，并使用找到的第一个文件进行请求处理；该处理在当前上下文中执行。文件的路径是根据 root 和 alias 指令从 file 参数构造的。可以通过在名称末尾指定斜杠来检查目录是否存在，例如“ $ uri &#x2F;”。如果未找到任何文件，则将进行内部重定向到最后一个参数中指定的uri。</p>
<p>最后一个参数可以指向一个 location ，也可以是状态码。例如：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">root</span> html;</span><br><span class="line">    <span class="attribute">error_page</span> <span class="number">400</span> /40x.html;</span><br><span class="line">    <span class="attribute">error_page</span> <span class="number">500</span> /50x.html;</span><br><span class="line">    </span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="comment"># try_files /system/maintenance.html @mongrel;</span></span><br><span class="line">        <span class="comment"># try_files /system/maintenance.html /40x.html;</span></span><br><span class="line">        <span class="comment"># try_files $uri /images/default.gif;</span></span><br><span class="line">        <span class="comment"># try_files $uri $uri/index.html $uri.html =500;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> = /images/default.gif &#123;</span><br><span class="line">        <span class="attribute">expires</span> <span class="number">30s</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="section">location</span> <span class="variable">@mongrel</span> &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://www.baidu.com;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Nginx优化"><a href="#Nginx优化" class="headerlink" title="Nginx优化"></a>Nginx优化</h1><p> <a target="_blank" rel="noopener" href="https://juejin.im/entry/5bd981a96fb9a022852a71da">百万并发下 Nginx 的优化之道</a> </p>
<p> <a target="_blank" rel="noopener" href="https://www.cnblogs.com/taiyonghai/p/5610112.html">Nginx 优化配置及详细注释</a> </p>
<p> <a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000011405320">Nginx 高并发下的优化</a> </p>
<p> <a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904122068680711">Nginx-性能优化</a> </p>
<h1 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h1><p>相信你已经阅读了 <a href>简单的代理服务器</a> 。</p>
<p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html">http://nginx.org/en/docs/http/ngx_http_proxy_module.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.yiibai.com/nginx/reverse-proxy.html">https://www.yiibai.com/nginx/reverse-proxy.html</a></p>
<h1 id="压缩和解压"><a href="#压缩和解压" class="headerlink" title="压缩和解压"></a>压缩和解压</h1><p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_gzip_module.html">http://nginx.org/en/docs/http/ngx_http_gzip_module.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.yiibai.com/nginx/compression-and-decompression.html">https://www.yiibai.com/nginx/compression-and-decompression.html</a></p>
<h1 id="内容缓存"><a href="#内容缓存" class="headerlink" title="内容缓存"></a>内容缓存</h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>当启用缓存时，nginx 将响应缓存到临时文件，并使用它们来响应客户端，而不必每次都为同一内容代理请求。</p>
<h2 id="启用响应缓存"><a href="#启用响应缓存" class="headerlink" title="启用响应缓存"></a>启用响应缓存</h2><p>在 <code>http</code> 上下文中包含 <a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html?&_ga=1.14314615.1509956953.1490042234#proxy_cache_path">proxy_cache_path</a> 指令。</p>
<p><code>path</code> 参数定义缓存路径。</p>
<p><code>keys_zone</code> 参数定义共享存储区的名称和大小（所有活跃的 <code>keys</code> 和有关数据的信息都存储在共享存储区中）。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    proxy_cache_path /data/nginx/cache keys_zone=one:10m;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在要缓存服务器响应的上下文（ <code>http</code> ，<code>server</code> 或 <code>location</code> ）中包含 <code>proxy_cache</code> 和 <code>proxy_cache_valid</code> 指令，</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">proxy_cache_path</span> /data/nginx/cache keys_zone=one:<span class="number">10m</span>;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">proxy_cache</span> one;</span><br><span class="line">        <span class="comment"># proxy_cache_valid 60m;</span></span><br><span class="line">        <span class="attribute">proxy_cache_valid</span> <span class="number">24h</span>;</span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://localhost:8000;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>请注意，由 <code>keys_zone</code> 参数定义的大小不会限制缓存的响应数据量。要限制缓存的响应数据量，请将 <code>max_size</code> 参数包含到 <code>proxy_cache_path</code> 指令中。</p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p><a target="_blank" rel="noopener" href="https://www.yiibai.com/nginx/content-caching.html">https://www.yiibai.com/nginx/content-caching.html</a></p>
<h1 id="配置日志"><a href="#配置日志" class="headerlink" title="配置日志"></a>配置日志</h1><p><a target="_blank" rel="noopener" href="https://www.yiibai.com/nginx/logging-and-monitoring.html">https://www.yiibai.com/nginx/logging-and-monitoring.html</a></p>
<p> 设置错误日志 、 设置访问日志 </p>
<h1 id="主要应用场景"><a href="#主要应用场景" class="headerlink" title="主要应用场景"></a>主要应用场景</h1><p><a target="_blank" rel="noopener" href="https://www.yiibai.com/nginx/nginx-main-use-scenes.html">https://www.yiibai.com/nginx/nginx-main-use-scenes.html</a></p>
<p>反向代理：ngx_http_proxy_module</p>
<p>负载均衡：ngx_http_upstream_module </p>
<p>HTTP服务器(包含动静分离)</p>
<p>正向代理</p>
<h1 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h1><h2 id="ngx-http-auth-basic-module"><a href="#ngx-http-auth-basic-module" class="headerlink" title="ngx_http_auth_basic_module"></a>ngx_http_auth_basic_module</h2><p>该模块允许通过使用”HTTP 基本身份验证”协议验证用户名和密码来限制对资源的访问。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装带有htpasswd工具的依赖包</span></span><br><span class="line">dnf install httpd-tools         <span class="comment"># centos</span></span><br><span class="line">apt-get install apache2-utils   <span class="comment"># ubuntu</span></span><br><span class="line"></span><br><span class="line">。####################### htpasswd 创建密码文件，它会交互式要求你输入密码。#######################</span><br><span class="line"><span class="comment"># -c 是创建新文件，如果之后要添加更多用户，不要加 -c，否则会覆盖已有文件。</span></span><br><span class="line"><span class="comment"># .htpasswd 文件中存储的是 用户名 + 加密后的密码。加密算法有多种类，比如：</span></span><br><span class="line"><span class="comment">#    d：crypt()（老旧，弱）</span></span><br><span class="line"><span class="comment">#    m：MD5</span></span><br><span class="line"><span class="comment">#    s：SHA</span></span><br><span class="line"><span class="comment">#    B：bcrypt（推荐）</span></span><br><span class="line">htpasswd -c /data/local/nginx/conf/.htpasswd zhaolq</span><br><span class="line">htpasswd /data/local/nginx/conf/.htpasswd lanqi</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 .htpasswd 内容格式</span></span><br><span class="line">ll -a /data/local/nginx/conf</span><br><span class="line"><span class="built_in">cat</span> /data/local/nginx/conf/.htpasswd</span><br><span class="line">zhaolq:$apr1<span class="variable">$fQK6V</span>/ct<span class="variable">$QqBO6WZ3kEsQ2MDGhItWt</span>.</span><br><span class="line">lanqi:$apr1$hHwzChNV<span class="variable">$63MFKfXDeTebbpCc2OCT</span>./</span><br><span class="line"></span><br><span class="line"><span class="comment"># .htpasswd 文件权限分配</span></span><br><span class="line"><span class="built_in">chown</span> nginx:nginx /data/local/nginx/conf/.htpasswd</span><br><span class="line"><span class="built_in">chmod</span> 644 /data/local/nginx/conf/.htpasswd</span><br></pre></td></tr></table></figure>




    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>请我一杯咖啡吧！</div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.png" alt="zhaolq 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="/images/alipay.png" alt="zhaolq 支付宝">
        <span>支付宝</span>
      </div>

  </div>
</div>

          <div class="post-tags">
              <a href="/tags/Nginx/" rel="tag"># Nginx</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/article/2019/11/SpringBoot%E5%AE%9E%E7%8E%B0%E8%B7%A8%E5%9F%9F%E7%9A%845%E7%A7%8D%E6%96%B9%E5%BC%8F/" rel="prev" title="SpringBoot实现跨域的5种方式">
                  <i class="fa fa-angle-left"></i> SpringBoot实现跨域的5种方式
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/article/2019/11/%E5%9B%9B%E5%B1%82%E3%80%81%E4%B8%83%E5%B1%82%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84%E5%8C%BA%E5%88%AB/" rel="next" title="四层、七层负载均衡的区别">
                  四层、七层负载均衡的区别 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2019 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">zhaolq</span>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
